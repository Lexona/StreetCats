<!DOCTYPE html>

<header>
  <label id="logo">StreetCats</label>
  <div class="header-links">
    <a routerLink="/">Home</a>
    @if (authService.isAuthenticated()) {
      <button class="logout-btn" (click)="authService.logout().subscribe()">Logout</button>
    } @else {
      <a routerLink="/login">Login</a>
    }
  </div>
</header>

<main>
  @if (isLoading()) {
    <div class="loading-container">
      <div class="spinner-large"></div>
      <p>Caricamento in corso...</p>
    </div>
  } @else if (errorMessage()) {
    <div class="error-container">
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <h2>{{errorMessage()}}</h2>
      <button class="btn-back" (click)="goBack()">Torna alle segnalazioni</button>
    </div>
  } @else if (signal()) {
    <div class="detail-container">
      <nav class="breadcrumb">
        <a routerLink="/signals">Segnalazioni</a>
        <span class="separator">/</span>
        <span class="current">{{signal()!.title}}</span>
      </nav>

      <!-- Main Content -->
      <div class="content-wrapper">
        <!-- Left side -->
        <aside class="image-section">
          <div class="image-container">
            <img [src]="getImageUrl(signal()!.photo_url)" [alt]="signal()!.title">
          </div>

          <!-- Map below image -->
          <div class="map-container">
            <h3>Posizione dell'avvistamento</h3>
            <div id="detail-map" class="map"></div>
            <div class="coordinates-info">
              <div class="coord-item">
                <span class="label">Latitudine:</span>
                <span class="value">{{signal()!.latitude}}</span>
              </div>
              <div class="coord-item">
                <span class="label">Longitudine:</span>
                <span class="value">{{signal()!.longitude}}</span>
              </div>
            </div>
          </div>
        </aside>

        <!-- Right Side -->
        <section class="details-section">
          <div class="header-actions">
            <button class="btn-back-small" (click)="goBack()">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
              </svg>
              Indietro
            </button>

            @if (canDelete()) {
              <button
                class="btn-delete"
                (click)="deleteSignal()"
                [disabled]="isDeleting()"
              >
              @if (isDeleting()) {
                <span class="spinner-small"></span>
                Eliminazione...
              } @else {
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Elimina
              }
              </button>
            }
          </div>

          <h1 class="title">{{signal()!.title}}</h1>
          <div class="meta-info">
            <div class="meta-item">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              <span>Segnalato da <strong>{{signal()!.User?.userName}}</strong></span>
            </div>

            <div class="meta-item">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              <span>{{formatDate(signal()!.createdAt!)}}</span>
            </div>
          </div>

          @if (signal()!.description) {
            <div class="description-section">
              <h2>Descrizione</h2>
              <div class="description-content">
                <markdown [data]="signal()!.description"></markdown>
              </div>
            </div>
          }

          <!-- Comment section placeholder -->
          <div class="comments-section">
            <h2>Commenti ({{ comments().length }})</h2>
            
            @if (authService.isAuthenticated()) {
              <form class="add-comment-form" (ngSubmit)="onAddComment()">
                <label for="commentText">Aggiungi un commento</label>
                <textarea
                id="commentText"
                rows="4"
                placeholder="Scrivi qui il tuo commento..."
                [(ngModel)]="newCommentText"
                [ngModelOptions]="{standalone: true}"
                [disabled]="isSubmittingComment()"
                ></textarea>

                @if (commentError()) {
                  <div class="comment-error">{{commentError()}}</div>
                }

                <div class="form-actions">
                  <button type="submit" [disabled]="isSubmittingComment() || newCommentText().trim() === ''">
                    @if (isSubmittingComment()) {
                      <span class="spinner-small"></span> Invio...
                    } @else {
                      Invia Commento
                    }
                  </button>
                </div>
              </form>
            } @else {
              <div class="comment-login-prompt">
                <a routerLink="/login">Accedi</a> per lasciare un commento.
              </div>
            }

            <div class="comments-list">
              @if (comments().length === 0) {
                <div class="comments-empty-state">
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                  </svg>
                  <p>Non ci sono ancora commenti. Sii il primo!</p>
                </div>
              } @else {
                @for (comment of comments(); track comment.id) {
                  <div class="comment-item">
                    <div class="comment-header">
                      <div class="comment-author">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                          <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        <strong>{{ comment.User.userName }}</strong>
                      </div>
                      <span class="comment-date">{{ formatDate(comment.createdAt) }}</span>
                    </div>

                    <div class="comment-body">
                      <p> {{ comment.text }} </p>
                    </div>

                    @if (canDeleteComment(comment)) {
                      <div class="comment-actions">
                        <button (click)="onDeleteComment(comment.id)" class="btn-delete-comment">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                          </svg>
                          Elimina
                        </button>
                      </div>
                    }
                  </div>
                }
              }
            </div>
          </div>
        </section>
      </div>
    </div>
  }
</main>